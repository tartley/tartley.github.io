<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A website devoted to oneself has been described — by my own Father, no less — as the greatest act of hubris. Welcome aboard!">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>tartley.com (old posts, page 28) | tartley.com</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://www.tartley.com/index-28.html">
<link rel="icon" href="welcome.gif" sizes="16x16">
<link rel="prev" href="." type="text/html">
<link rel="next" href="index-27.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://www.tartley.com/">

                <span id="blog-title">tartley.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Posts</a>
                </li>
<li>
<a href="tags/">Tags</a>
                </li>
<li>
<a href="galleries/Drawings">Gallery</a>
                </li>
<li>
<a href="rss.xml">RSS</a>
                </li>
<li>
<a href="about/">About</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://www.tartley.com/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    <a rel="me" href="https://mastodon.social/@tartley"></a>
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/til-git-push-force-with-lease/" class="u-url">TIL: git push --force-with-lease</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/til-git-push-force-with-lease/" rel="bookmark">
            <time class="published dt-published" datetime="2023-08-04T13:48:19-05:00" itemprop="datePublished" title="2023-08-04 13:48">2023-08-04 13:48</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Don't ever type <code>git push --force</code>. Yes, there are times we have to hold our
nose and do a force push. Maybe the project requires contributions to be
rebased or squashed. Maybe we pushed the nuclear launch codes. But there are
failure modes:</p>
<ul>
<li>You might be accidentally pushing to or from the wrong branch, and hence are
  about to blow away valuable work at the remote. Yes, is unlikely, and can be
  fixed after the fact, but who knows how much embarrassing disruption and
  confusion you'll cause the team before you realize what you did.</li>
<li>Do you <em>always</em> remember to check the state of the remote, to make sure there
  isn't unexpected extra commits on the remote that you'll unknowingly blow
  away when you push? Do you enjoy always having to type those extra commands
  to pull and check the remote commits?</li>
<li>No matter how conscientious we are about checking the above, there is a race
  condition. We might check the remote, then someone else pushes valuable
  changes, then we force push and blow them away.</li>
</ul>
<p>Although there are conventions that can help with all the above (e.g. only ever
force pushing to your own fork, to which nobody else ever pushes), they aren't
generally watertight. (e.g. you might have pushed something yourself, before
vacation, and forgotten about it.)</p>
<p>So the generally agreed method to avoid the above failure modes is "be more
careful", which sounds to me like the common prelude to failure. What we need
are push's newer command-line options:</p>
<dl>
<dt><code>--force-with-lease</code></dt>
<dd>Like <code>--force</code>, but refuses to push if the remote ref doesn't point at the
same commit that our local remote-tracking branch 'origin/mybranch' thinks it
should. So if someone else pushes something to the remote's 'mybranch' just
before we try to force push, our push will fail until we pull (and, in theory,
inspect) those commits that we were about to blow away.</dd>
</dl>
<p>It turns out that this is inadequate. One might have fetched an up-to-date remote
branch, but somehow or other ended up with our local HEAD on a divergent branch
anyway:</p>
<div class="code"><pre class="code literal-block">C origin/mybranch
|
B¹   B² HEAD mybranch
 \ /
  A
  |
</pre></div>

<p>In this situation, <code>--force-with-lease</code> will allow us to push, not only blowing
away the original commit B¹, as we intended, but also C, which was maybe pushed
by someone else before we fetched.</p>
<p>To guard against this, we can use the even newer option:</p>
<dl>
<dt><code>--force-if-includes</code></dt>
<dd>This makes <code>--force-with-lease</code> even more strict about rejecting pushes,
using clever heuristics on your local reflog, to check that the remote ref
being updated doesn't include commits which have never been part of your local
branch.</dd>
</dl>
<p>Upshot is, I plan to default to always replacing uses of <code>--force</code> with:</p>
<div class="code"><pre class="code literal-block">git<span class="w"> </span>push<span class="w"> </span>--force-with-lease<span class="w"> </span>--force-if-includes<span class="w"> </span>...
</pre></div>

<p>That's a lot to type, the options don't have short versions, and it's easy to forget to
do. Hence, shadow <code>git</code> to enforce it, and make it easy. In .bashrc or similar:</p>
<div class="code"><pre class="code literal-block"><span class="c1"># Shadow git to warn againt the use of 'git push -f'</span>
git<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nv">is_push</span><span class="o">=</span><span class="nb">false</span>
<span class="w">    </span><span class="nv">is_force</span><span class="o">=</span><span class="nb">false</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>arg<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$arg</span><span class="s2">"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"push"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">is_push</span><span class="o">=</span><span class="nb">true</span>
<span class="w">        </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$arg</span><span class="s2">"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"-f"</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">"</span><span class="nv">$arg</span><span class="s2">"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"--force"</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">is_force</span><span class="o">=</span><span class="nb">true</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$is_push</span><span class="s2">"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$is_force</span><span class="s2">"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="c1"># Suggest alternative commands.</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"git push -f: Consider 'git push --force-with-lease --force-if-includes' instead, which is aliased to 'gpf'"</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="c1"># Run the given command, using the git executable instead of this function.</span>
<span class="w">    </span><span class="k">$(</span>which<span class="w"> </span>git<span class="k">)</span><span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c1"># git push force: using the new, safer alternatives to --force</span>
gpf<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1"># Older versions of git don't have --force-if-includes. Fallback to omitting it.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>--quiet<span class="w"> </span>--force-with-lease<span class="w"> </span>--force-if-includes<span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span>git<span class="w"> </span>push<span class="w"> </span>--quiet<span class="w"> </span>--force-with-lease<span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</pre></div>

<p>Then trying to do it wrong tells you how to easily do it right:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>-f
git<span class="w"> </span>push<span class="w"> </span>-f:<span class="w"> </span>Consider<span class="w"> </span><span class="s1">'git push --force-with-lease --force-if-includes'</span><span class="w"> </span>instead,<span class="w"> </span>which<span class="w"> </span>is<span class="w"> </span>aliased<span class="w"> </span>to<span class="w"> </span><span class="s1">'gpf'</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span>
$<span class="w"> </span>gpf
$
</pre></div>

<p>(The [1] is my prompt telling me that the last command had an error exit value.)</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/structured-pattern-matching-in-python/" class="u-url">Structured Pattern Matching in Python</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/structured-pattern-matching-in-python/" rel="bookmark">
            <time class="published dt-published" datetime="2023-07-29T18:15:26-05:00" itemprop="datePublished" title="2023-07-29 18:15">2023-07-29 18:15</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>I read through descriptions of
<a href="https://docs.python.org/3.11/reference/compound_stmts.html#the-match-statement">structured pattern matching</a>
when it was added in Python 3.10 a couple of years ago, and have studiously
avoided it ever since. It seemed like a language feature that's amazingly
useful in one or two places, like writing a parser, say, and is a horrifically
over-complicated mis-step just about everywhere else.</p>
<blockquote>
<p><strong>Update:</strong> A day after writing this I see that Guido van
Rossum wrote exactly that,
<a href="https://github.com/gvanrossum/patma/blob/master/examples/expr.py">a parser</a>,
to showcase the feature. I'm guessing he writes a lot of parsers. I definitely
don't write enough of them to think this language feature is worth the extra
complexity it brings.</p>
</blockquote>
<p>Regardless, I really ought to remember how it works, so this is my attempt to
make the details stick, by writing about it.</p>
<p>If you're not me, you really ought to be reading about it from the source instead:</p>
<ul>
<li>
<a href="https://peps.python.org/pep-0634/">PEP 643</a>: Specification.</li>
<li>
<a href="https://peps.python.org/pep-0635/">PEP 635</a>: Motivation and rationale.</li>
<li>
<a href="https://peps.python.org/pep-0636/">PEP 636</a>: A tutorial.</li>
</ul>
<h2>Basic structure</h2>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">EXPRESSION</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PATTERN1</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">case</span> <span class="n">PATTERN2</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>

<p>This evaluates the <code>match</code> EXPRESSION, then tries to match it against each
<code>case</code> PATTERN, executing the body of the first case that matches, falling back
to the optional final <code>_</code> default case. (<code>match</code> and <code>case</code> are not keywords,
except in the context of a match...case block, so you can continue using them
as variable names elsewhere.)</p>
<p>But what are PATTERNs, and how are they tested for a match?</p>
<h2>Patterns</h2>
<p>Patterns can be any of the following. As becomes increasingly obvious down the
list, the real power of this feature comes from composing each of these
patterns with the others. For complicated patterns, parentheses can be used to
indicate order of operations.</p>
<h3>Literals</h3>
<p>Like other languages' traditional <code>switch</code> statement:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">mycommand</span><span class="p">:</span>
    <span class="k">case</span> <span class="s1">'start'</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">case</span> <span class="s1">'stop'</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CommandNotFoundError</span><span class="p">(</span><span class="n">mycommand</span><span class="p">)</span>
</pre></div>

<p>Such literal case patterns may be strings (including raw and byte-strings, but
not f-strings), numbers, booleans or None.</p>
<p>Such cases are compared with equality:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="mi">123</span><span class="p">:</span>
    <span class="k">case</span> <span class="mf">123.0</span><span class="p">:</span>
        <span class="c1"># matches!</span>
</pre></div>

<p>except for booleans and None, which are compared using <code>is</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="nc">Any</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="n">myfalse</span> <span class="o">=</span> <span class="n">Any</span><span class="p">()</span>

<span class="k">match</span> <span class="n">myfalse</span><span class="p">:</span>
    <span class="k">case</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Doesn't match, even though myfalse == False</span>
        <span class="k">assert</span> <span class="kc">False</span>
</pre></div>

<h3>Variable names</h3>
<p>We can replace a literal with a variable name, to capture the value of the match
expression.</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">command</span><span class="p">:</span>
    <span class="k">case</span> <span class="s1">'start'</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">case</span> <span class="s1">'stop'</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">case</span> <span class="n">unknown</span><span class="p">:</span>
        <span class="c1"># New variable 'unknown' is assigned the value of command</span>
</pre></div>

<p>The 'default' case pattern <code>_</code> is just a special case variable name which
binds no name.</p>
<p>Beware the common error of using "constants" as the case pattern:</p>
<div class="code"><pre class="code literal-block"><span class="n">NOT_FOUND</span> <span class="o">=</span> <span class="mi">404</span>

<span class="k">match</span> <span class="n">error</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">NOT_FOUND</span><span class="p">:</span> <span class="c1"># bad</span>
        <span class="n">handle_404</span><span class="p">()</span>
</pre></div>

<p>The above case is intended to test for <code>error == NOT_FOUND</code>, but instead
assigns the variable <code>NOT_FOUND = error</code>. The best defense is to always include
a default catch-all case at the end, which causes the above <code>NOT_FOUND</code> case to
produce a SyntaxError:</p>
<div class="code"><pre class="code literal-block"><span class="n">NOT_FOUND</span> <span class="o">=</span> <span class="mi">404</span>

<span class="k">match</span> <span class="n">error</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">NOT_FOUND</span><span class="p">:</span>
        <span class="n">handle_404</span><span class="p">()</span>
    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

<div class="code"><pre class="code literal-block"><span class="n">SyntaxError</span><span class="o">:</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">capture</span><span class="w"> </span><span class="s1">'NOT_FOUND'</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">patterns</span><span class="w"> </span><span class="n">unreachable</span>
</pre></div>

<p>To use a 'constant' in a case pattern like this, qualify it with a dotted name,
such as by using an <code>enum.Enum</code>:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">error</span>
    <span class="k">case</span> <span class="n">errors</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">:</span>
        <span class="c1"># correctly matches</span>
</pre></div>

<h3>Sequences</h3>
<p>Using a list-like or tuple-like syntax, matches must have the right number of
items. Like Python's existing iterable unpacking feature. Use <code>*</code> to match the
rest of a sequence. Included variable names are set if a case matches by all
other criteria.</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">command</span><span class="p">:</span>
    <span class="k">case</span> <span class="p">(</span><span class="s1">'start'</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># New variable name=command[1]</span>
    <span class="k">case</span> <span class="p">(</span><span class="s1">'stop'</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># New variable name=command[1]</span>
    <span class="k">case</span> <span class="p">(</span><span class="s1">'stop'</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
        <span class="c1"># New variables name=command[1], delay=command[2]</span>
    <span class="k">case</span> <span class="p">(</span><span class="s1">'stop'</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="o">*</span><span class="n">extra</span><span class="p">):</span>
        <span class="c1"># New variables name=command[1], delay=command[2] &amp; extra=command[3:]</span>
    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadCommand</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

<h3>Mappings</h3>
<p>Using a dict-like syntax. The match expression must must contain a
corresponding mapping, and can contain other keys, too. Use <code>**</code> to match the
rest of a mapping.</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">config</span><span class="p">:</span>
    <span class="k">case</span> <span class="p">{</span><span class="s1">'host'</span><span class="p">:</span> <span class="n">hostname</span><span class="p">}:</span>
        <span class="c1"># 'config' must contain key 'host'. New variable hostname=config['host']</span>
    <span class="k">case</span> <span class="p">{</span><span class="s1">'port'</span><span class="p">:</span> <span class="n">portnumber</span><span class="p">}:</span>
        <span class="c1"># 'config' must contain key 'port'. New variable portnumber=config['port']</span>
        <span class="c1"># Remember we only use the first matching case.</span>
        <span class="c1"># If 'config' contains 'host', then this 'port' case will not match.</span>
    <span class="k">case</span> <span class="p">{</span><span class="s1">'scheme'</span><span class="p">:</span> <span class="n">scheme</span><span class="p">,</span> <span class="o">**</span><span class="n">extras</span><span class="p">}:</span>
        <span class="c1"># new variables 'scheme' and 'extras' are assigned.</span>
</pre></div>

<p>Case patterns may contain more than one key-value pair. The match expression must
contain all of them to match.</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="p">{</span>
        <span class="s1">'host'</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span>
        <span class="s1">'port'</span><span class="p">:</span> <span class="n">portnumber</span><span class="p">,</span>
    <span class="p">}:</span>
        <span class="o">...</span>
</pre></div>

<h3>Objects and their attributes</h3>
<p>Using class syntax, the value must match an isinstance check with the given class:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">event</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">Click</span><span class="p">():</span>
        <span class="c1"># handle click</span>
        <span class="o">...</span>
    <span class="k">case</span> <span class="n">KeyPress</span><span class="p">():</span>
        <span class="c1"># handle key press</span>
        <span class="o">...</span>
</pre></div>

<p>Beware the common error of omitting the parentheses:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">myval</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">Click</span><span class="p">:</span> <span class="c1"># bad</span>
        <span class="c1"># handle clicks</span>
</pre></div>

<p>The above case is intended to test for <code>isinstance(myval, Click)</code>, but instead
creates a new var, <code>Click = myval</code>. The best defence against this error is to
always include a default catch-all at the end, which makes the <code>Click</code> catch-all
produce an error by making subsequent patterns unreachable.</p>
<p>Attribute values for the class can be given, which must also match.</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">event</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">KeyPress</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="s1">'q'</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">game</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">case</span> <span class="n">KeyPress</span><span class="p">():</span>
        <span class="n">handle_keypress</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</pre></div>

<p>Values can also be passed as positional args to the class-like case syntax:</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="n">KeyPress</span><span class="p">(</span><span class="s1">'q'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>

<p>If the class is a namedtuple or dataclass, then positional args to a class-like
case pattern can automatically be handled using the unambiguous ordering of its
attributes:</p>
<div class="code"><pre class="code literal-block"><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Dog</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">color</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="s1">'dash'</span><span class="p">,</span> <span class="s1">'golden'</span><span class="p">)</span>

<span class="k">match</span> <span class="n">d</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">Dog</span><span class="p">(</span><span class="s1">'dash'</span><span class="p">,</span> <span class="s1">'golden'</span><span class="p">):</span>
        <span class="c1"># matches</span>
</pre></div>

<p>But for regular classes, the ordering of the class attributes is ambiguous.
To fix this, add a <code>__match_args__</code> attribute on the class, a tuple which
specifies which class attributes, in which order, can be specified in a case
pattern:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="nc">KeyPress</span><span class="p">:</span>
    <span class="n">__match_args__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'key_name'</span><span class="p">,</span> <span class="s1">'release'</span><span class="p">)</span>

<span class="n">event</span> <span class="o">=</span> <span class="n">KeyPress</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="s1">'q'</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">match</span> <span class="n">event</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">KeyPress</span><span class="p">(</span><span class="s1">'q'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># matches!</span>
</pre></div>

<p>As you might expect, the literal positional args can be replaced with variable
names to capture attribute values instead:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">event</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">KeyPress</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span> <span class="c1"># names unimportant, order matters</span>
        <span class="n">handle_keypress</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</pre></div>

<p>Positional sub-patterns behave slightly differently for builtins <code>bool</code>,
<code>bytearray</code>, <code>bytes</code>, <code>dict</code>, <code>float</code>, <code>frozenset</code>, <code>int</code>, <code>list</code>, <code>set</code>,
<code>str</code>, and <code>tuple</code>. A positional value is matched by equality against the match
expression itself, rather than an attribute on it:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="mi">123</span><span class="p">:</span>
    <span class="k">case</span> <span class="nb">int</span><span class="p">(</span><span class="mi">123</span><span class="p">):</span>
        <span class="c1"># matches</span>
    <span class="k">case</span> <span class="nb">int</span><span class="p">(</span><span class="mf">123.0</span><span class="p">):</span>
        <span class="c1"># would also match if it wasn't shadowed</span>
</pre></div>

<p>Similarly, a positional variable is assigned the value of the match expression
itself, not an attribute on that value:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="mi">123</span><span class="p">:</span>
   <span class="k">case</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="o">...</span>

<span class="k">assert</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">123</span>
</pre></div>

<p>The values passed as keyword or positional args to class-like case patterns can
be more than just literals or variable names. In fact they can use <em>any</em> of the
listed pattern types. For example, they could be a nested instance of this
class-like syntax:</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="nc">Location</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">Car</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>

<span class="n">mycar</span> <span class="o">=</span> <span class="n">Car</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>

<span class="k">match</span> <span class="n">mycar</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">Car</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))):</span>
        <span class="c1"># matches, and captures 'x' and 'y'</span>

<span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">11</span>
<span class="k">assert</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">22</span>
</pre></div>

<h3>Combine patterns using <code>|</code>
</h3>
<p>To match either one pattern or another:</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="mi">1</span> <span class="o">|</span> <span class="kc">True</span> <span class="o">|</span> <span class="s1">'true'</span> <span class="o">|</span> <span class="s1">'on'</span> <span class="o">|</span> <span class="s1">'yes'</span><span class="p">:</span>
        <span class="c1"># matches any of those values</span>
</pre></div>

<h3>Capture sub-patterns using <code>as</code>
</h3>
<p>We've seen how we can either match against a value, or capture the value using
a variable name. We can do both using <code>as</code>:</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="s1">'a'</span> <span class="o">|</span> <span class="s1">'b'</span> <span class="k">as</span> <span class="n">ab</span><span class="p">:</span>
        <span class="c1"># matches either value, captures what the value actually was</span>
</pre></div>

<p>This might not be much use when capturing the whole match expression like that.
If the match expression is just a variable, then we could instead simply refer
to that variable. But using <code>as</code> can be useful when the match expression is
lengthy or has side-effects:</p>
<div class="code"><pre class="code literal-block"><span class="k">match</span> <span class="n">events</span><span class="o">.</span><span class="n">get_next</span><span class="p">():</span>
    <span class="k">case</span> <span class="n">KeyDown</span><span class="p">()</span> <span class="k">as</span> <span class="n">key_event</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>

<p>or to capture just a component of the whole expression. Contrived example:</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="p">(</span><span class="s1">'a'</span> <span class="o">|</span> <span class="s1">'b'</span> <span class="k">as</span> <span class="n">ab</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">):</span>
        <span class="c1"># matchs ['a', 'c'] or ['b', 'c'], and captures the first letter in 'ab'</span>
</pre></div>

<h4>An <code>if</code> guard clause</h4>
<p>Add arbitrary conditions to the match:</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="c1"># matches integers less than 100</span>
</pre></div>

<p>Or, alternatively:</p>
<div class="code"><pre class="code literal-block">    <span class="k">case</span> <span class="nb">int</span><span class="p">()</span> <span class="k">as</span> <span class="n">i</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="c1"># matches integers less than 100</span>
</pre></div>

<h2>Complications</h2>
<p>This feature seems rife with complexity. The flexible syntax of case patterns
forms a new mini-language, embedded within Python. It has many similarities to
Python, but also many initially unintuitive differences.</p>
<p>For example, a class-like case pattern such as <code>case Click():</code>. Anywhere else
in the language, the expression like <code>Click(...)</code> would create an instance of the
<code>Click</code> class. In a case statement, it instead is doing things like
<code>isinstance</code> and <code>hasattr</code> checks.</p>
<p>Similarly, including variable names doesn't return the variable value as in
ordinary Python. Instead it binds a value as that name. This is the source of
the annoying gotcha described above, that bare "constants" like <code>NOT_FOUND</code>
behave very unexpectedly when used as case expressions.</p>
<p>There are a few places in real-world code where structured pattern matching
will produce nicer code than the equivalent using nested <code>elif</code>s. But equally,
there are a lot of places where the <code>elif</code>s are a more natural match.
Developers now get to choose which they're going to use, and then later
disagree with each other about it, or simply change their mind, and end up
converting code from one to the other.</p>
<p>If this was a simple feature, with low overheads, then I'd forgive its
inclusion in the language, accepting the costs in return for the marginal and
unevenly distributed benefits.</p>
<p>But it's really not simple. In addition to Python programmers all having to
do an exercise like this post just to add it to their mental toolbox, it needs
maintenance effort, not just in CPython but in other implementations too, and
needs handling by tools such as syntax highlighters, type checkers. It really
doesn't seem like a net win to me, <em>unless</em> you're writing way more parsers
than the average programmer, which no doubt the champions of this feature are.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/ur-fascism/" class="u-url">Ur-Fascism</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/ur-fascism/" rel="bookmark">
            <time class="published dt-published" datetime="2023-07-11T19:41:42-05:00" itemprop="datePublished" title="2023-07-11 19:41">2023-07-11 19:41</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p><span style="float: left">
<img alt="Ur-Fascism cover" src="files/2023/ur-fascism-cover.webp"></span></p>
<p><em>by Umberto Eco, 1995.</em></p>
<p>Eco's prose has left me in the dust on occasion in the past. I missed so many references, or failed to keep up with the relentlessly nested layers of meaning, that I was simply holding on for the ride. This essay matches Eco's characteristically dense, intellectual prose, studded with foreign phrases, and references to contemporary thinkers, historical movements and causes and revolutions and dictatorships, and their antecedents. But it is short, and perhaps in contrast to the flourishes of brilliance that comprise his fiction, this is a factual piece, and is written to be understood rather than to dazzle. It begins by establishing Eco's credentials to speak on this topic, with the first of several entrancing first-hand indications of what it was like to grow up as an intellectual young child in Italy under Mussolini, and the revelations that followed at the opening up of his world at the end of WWII.</p>
<p>He differentiates between the truly totalitarian fascism of, say, Nazism, which subordinated all of life to the state, with the looser, less coherent Italian fascism, noting that this did not derive from any increment of tolerance, merely the absence of a sufficiently encompassing underlying philosophy. Despite this, it is the Italian mode, which was the first right wing dictatorship in modern history, from which subsequent dictators seem to have drawn most stylistic inspiration, and from which our generic term of "fascism" derives.</p>
<p>The last half of the essay describes how fascism means different things in different contexts, but the various incarnations through history have exhibited sufficiently overlapping sets of symptoms as to glean a family resemblance. Eco enumerates 13 identifying traits, noting that the presence of even one of them can be sufficient to allow fascism to coagulate around it. Mostly for my own benefit, (with my own parenthesised observations) they are, briefly:</p>
<ol>
<li>
<p>Fascism incorporates a cult of tradition. This can be deployed as an automatic refutation of any undesirable new ideas, enshrining in their place the immutable wisdom of a mythical past. In addition, traditionalism undermines the perceived value of learning in itself - pre-emptively thwarting troublesome intellectuals. This anti-intellectual received wisdom, in order to provide whichever justifications are required of it, requires the syncretistic combination of various ancient beliefs. As a result it must tolerate contradictions. Indeed, the more stark they are, the better they serve the purpose of selecting followers who will obediently think whatever they are told.</p>
</li>
<li>
<p>The rejection of modernism. This is a powerful recruiting tool, enabling the fascist to leverage any dissatisfaction of the populous, laying claim to the emotionally appealing universal solution of a regression to simpler, happier times, while simultaneously rewinding societal progress in equality or liberty. While Nazis and fascists love their technology, this is a superficial tool, used in support of a deeply regressive project, namely the restoration of power to those with the strength and the will to take it. This irrationality goes hand in hand with anti-intellectualism.</p>
</li>
<li>
<p>Value vigor and action above reflection. Thinking is emasculation. Culture is suspect insofar as it aligns with any sort of critical theory or values. Regard centers of analysis or learning such as libraries or universities with suspicion for harboring - or even indoctrinating - people of opposing political viewpoints. Again, this is deeply intertwined with (1) &amp; (2), and its prevalence pre-emptively defuses any kind of mainstream understanding or critique.</p>
</li>
<li>
<p>All of the above make it inevitable that any given fascist regime will be rife with internal contradictions.  While modernity achieves its intellectual prowess through the nurturing of diverse thought, fascism cannot possibly withstand any critical analysis. Hence, disagreement is treason.</p>
</li>
<li>
<p>The fascist appeal to popularity exploits and exacerbates the natural fear of <em>the other</em>, and hence is always inherently racist. Expect demonization of immigrants, foreigners, other nation states, as well as other marginalized groups, taking advantage of whatever local contemporary biases and fears might be present.</p>
</li>
<li>
<p>The above exploitation takes the form of an appeal to the frustrations of the middle class - or whichever class can be most useful and readily mobilized by persuasion that their problems are caused by some identifiable other.</p>
</li>
<li>
<p>Modernity genuinely does disintegrate traditional social bonds, along with sources of identity and meaning. Fascism's solution to this is to unify the disaffected under the only remaining banner common to them all, that of patriotism and nationalism. This unity is strengthened by emphasis on the country's enemies, and especially by conspiracy theories of secret international plots against the nation. Followers must feel besieged (as Trump advised the January 6th crowd that "America is under siege"). Eco makes special mention, in the U.S, of Pat Robertson's <em>The New World Order</em>, but potential sources of conspiracy are innumerable.</p>
</li>
<li>
<p>Followers can be riled into frenzy of humiliation at their enemies' wealth or power. Jews control the
world and its money. Instead of coastal liberals, refer to coastal elites. But at the same time, the instinct to action requires that enemies can easily be defeated. Hence enemies are simultaneously too weak and too strong. Herein lies one of fascism's greatest weaknesses, responsible for several lost wars, in that it is constitutionally incapable of objectively assessing an enemy's strength.</p>
</li>
<li>
<p>Goad followers into violent action with rhetoric not just of a struggle for survival, but by declaration that life is struggle, and hence pacifism is conspiring with the enemy.</p>
</li>
<li>
<p>While fascism appeals for the participation of the population by promising empowerment for the majority, its naked power lust is a fundamentally aristocratic endeavor. The leader takes power from those too weak to oppose  him, disdaining both conquered rivals and the subjugated population. Power struggles within the Party are vicious, and the party rides roughshod over the citizens, who likewise are leagues above the disenfranchised. The hierarchy is strict, steep, and ruthless. Elitism abounds, as does fear of losing one's status.</p>
</li>
<li>
<p>The redress of modernity's threadbare social fabric, by emphasizing nationalism and strength, further erodes interpersonal solidarity. Each individual must becomes their own hero. Strong, independent, and utterly without recourse in times of need. The cult of the hero is intimately entwined with a cult of death. Having only the narrow causes of the nation and the Party to live for, the hero yearns for a heroic death - or, better, to demonstrate their power and status by sending others to their death.</p>
</li>
<li>
<p>The preeminent will to power, so often frustrated in an aristocratic, dog-eat-dog social order, manifests alternately in things like machismo, disdain for women, and phallic fetishization of weapons. Repressed insecurity breeds an outward contempt for unconventional sexuality, including chastity.</p>
</li>
<li>
<p>Under fascism, the people have no innate rights, and hence no material preferences or expression. Instead, the leader pretends to interpret the Will of the People. This charade requires the party apparatus to select and amplify some emotional response of the people, and present it as representative, so that the party can be empowered to act on behalf of that supposedly majority. Consider the amplifications of manufactured outrage about culture war issues, so that elected representatives are empowered to act decisively on their own preferences, against the majority of the population's wishes. This leads directly to confrontation with institutions such as a parliament. Fascism will therefore cast aspersions on any properly functioning parliament's legitimacy.</p>
</li>
<li>
<p>All fascisms make use of their own varieties of NewSpeak, using an impoverished vocabulary and syntax, in order to limit the instruments for critical reasoning. This may appear in apparently innocent forms, from schoolbooks to popular talk shows.</p>
</li>
</ol>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/makefiles-that-are-self-documenting-and-process-all-extant-files/" class="u-url">TIL: Makefiles that are self-documenting, and process all extant files.</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/makefiles-that-are-self-documenting-and-process-all-extant-files/" rel="bookmark">
            <time class="published dt-published" datetime="2023-07-06T11:50:16-05:00" itemprop="datePublished" title="2023-07-06 11:50">2023-07-06 11:50</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <h3>Self-documenting Makefiles</h3>
<p>A trick from years ago, but I copy it around between projects enough that it
deserves calling out. Add a target:</p>
<div class="code"><pre class="code literal-block"><span class="nf">help</span><span class="o">:</span><span class="w"> </span><span class="c">## Show this help.</span>
<span class="c">    @# Optionally add 'sort' before 'awk'</span>
<span class="w">    </span>@grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">'^[a-zA-Z_\.%-]+:.*?## .*$$'</span><span class="w"> </span><span class="k">$(</span>MAKEFILE_LIST<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-10s\033[0m %s\n", $$1, $$2}'</span>
<span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">help</span>
</pre></div>

<p>Decorate other targets with a descriptive '##' comment, like "<em>Show this help</em>"
above. Now calling the 'help' target will summarize all the things the Makefile
can do. eg:</p>
<div class="code"><pre class="code literal-block">$ make help
help       Show this help.
setup      Install required system packages using 'apt install'.
%.pdf      Generate given PDF from corresponding .tex file.
all        Convert all .tex files to PDF.
</pre></div>

<p>You might choose to make 'help' the first target in the Makefile, so that it
gets triggered when the user runs <code>make</code> without arguments.</p>
<h3>Process all extant files</h3>
<p>Make's canonical paradigm is that you tell it the name of the file to generate,
and it uses the tree of dependencies specified in the Makefile to figure out
how to build it. Typically you'll use automatic variables like "$&lt;" to represent
the wildcarded source filename:</p>
<div class="code"><pre class="code literal-block"><span class="nf">%.pdf</span><span class="o">:</span><span class="w"> </span>%.<span class="n">tex</span> <span class="c">## Generate given PDF from corresponding .tex file.</span>
<span class="w">    </span>pdflatex<span class="w"> </span>$&lt;
</pre></div>

<p>The pitfall is that when invoking this, you have to name all the PDF files you
want to generate. If the names are a fixed part of your build, they can be
embedded in the Makefile itself:</p>
<div class="code"><pre class="code literal-block"><span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">one</span>.<span class="n">pdf</span> <span class="n">two</span>.<span class="n">pdf</span> <span class="n">three</span>.<span class="n">pdf</span>
</pre></div>

<p>But if their names are dynamic, you have to specify them on the command line,
which is a pain:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>make<span class="w"> </span>one.pdf<span class="w"> </span>two.pdf<span class="w"> </span>three.pdf
</pre></div>

<p>This is easy enough when <em>re-</em>generating all the PDFs that already exist:</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>make<span class="w"> </span>*.pdf
</pre></div>

<p>but is no help when you just have a bunch of .tex files and you just want Make
to build all of them. This is going the opposite way to canonical make usage.
We want to specify the existing source files (<code>*.tex</code>, in this case), and have
Make build the resulting products.</p>
<p>To do it, we need our Makefile to enumerate the existing source files:</p>
<div class="code"><pre class="code literal-block"><span class="nv">TEX_FILES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>wildcard<span class="w"> </span>*.tex<span class="k">)</span>
</pre></div>

<p>Using the 'wildcard' function here behaves better than a bare wildcard
expansion, e.g. it produces no output when there are no matches, rather than
outputting the unmatched wildcard expression.</p>
<p>Then use a substitution to generate the list of .pdf filenames:</p>
<div class="code"><pre class="code literal-block"><span class="nv">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">$(</span>TEX_FILES:%.tex<span class="o">=</span>%.pdf<span class="k">)</span>
</pre></div>

<p>Now <code>make all</code> will generate one .pdf file for each extant .tex file, regardless of
whether the corresponding .pdf files already exist or not.</p>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="." rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-27.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer"></footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
