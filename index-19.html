<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Creating a website devoted to oneself has been described as the greatest act of hubris. Welcome aboard!">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>tartley.com (old posts, page 19) | tartley.com</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://www.tartley.com/index-19.html">
<link rel="icon" href="welcome.gif" sizes="16x16">
<link rel="prev" href="index-20.html" type="text/html">
<link rel="next" href="index-18.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://www.tartley.com/">

                <span id="blog-title">tartley.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>
                </li>
<li>
<a href="pages/about/">About</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://www.tartley.com/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
    
    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/flying-high-hobbyist-opengl-from-python/" class="u-url">Flying High: Hobbyist OpenGL from Python</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/flying-high-hobbyist-opengl-from-python/" rel="bookmark">
            <time class="published dt-published" datetime="2010-07-31T14:58:30-05:00" itemprop="datePublished" title="2010-07-31 14:58">2010-07-31 14:58</time></a>
            </p>
                <p class="commentline">            <a href="posts/flying-high-hobbyist-opengl-from-python/#disqus_thread" data-disqus-identifier="cache/posts/flying-high-hobbyist-opengl-from-python.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p><em>This is a transcript-from-memory (what I wish I'd said) of the talk I
just gave at <a href="http://www.europython.eu/">EuroPython</a> 2010, for which I
owe a debt of gratitude to Richard Jones for his last-minute moral
support while wrestling with projectors and refresh rates; and to the
whole team of hard-working volunteers, especially John Pinner &amp; Richard
Taylor, who gave so much time and effort to make EuroPython in the UK
brilliant once again.</em></p>
<p><em>The demonstrated</em> <em>code</em> <em>is available at
<a href="https://github.com/tartley/gloopy">https://github.com/tartley/gloopy</a></em></p>
<hr>
<p>With this talk I want to give an overview of creating 3D graphics in
OpenGL from Python. Instead of covering topics already covered by a
thousand OpenGL tutorials, I want to shift attention towards some ideas
of how to generate the input to your renderer - how to algorithmically
create geometry. I'll show that with just a paltry few hundred lines of
relatively simple code, you can generate some interestingly chunky
shapes - virtual sculptures, if you will. Since this talk has the word
<em>hobbyist</em> in the title, I want to emphasise how easy this is, and I
want to have some fun with the pretty pictures.</p>
<p>Out of interest, how many people here are already expert OpenGL users
<em>(a few hands hesitantly go up, then some think about it and go down
again</em>) err, I mean how many have already used OpenGL to do anything at
all <em>(about half the people raise their hand</em>.) Alright, well, I want
you all to leave here enthused to go generate your own images or
animations or games.</p>
<h3><strong>Inspirations</strong></h3>
<p>As the field of computer graphics advances, there's an understandable
tendency for more photorealism, This is laudable, but I also feel that
the effort expended on achieving this technical goal is often undertaken
without considering whether photorealism is the best aesthetic choice
for a particular project.</p>
<p>In the past, games and other applications adopted particular visual
styles out of technical necessity. As is often the case, these
restrictions resulted in a diverse blossoming of creative ideas,
producing an enormous set of distinctive visual styles and experiences.</p>
<p><img alt="Non-photo-realistic Quake" src="files/2010/07/nprquake.jpg"></p>
<p>Crucially, the most successful and memorable examples of these were
projects that found ways to work in harmony with the restrictions of the
medium, rather than attempting to gloss over them.</p>
<p><img alt="Rez HD" src="files/2010/07/RezHDA.jpg"></p>
<p>Advances in computing power and technique provide modern games and
applications with a far wider range of options in how to present
themselves visually, and yet the greater proportion of them seem content
with a conventional and unimaginative 'near-photorealistic' appearance.
This disappoints me, because I feel that projects that opt for a more
highly stylised look, when appropriately chosen, can create a vastly
more striking and memorable artistic experiences. This is true in movies
and all kinds of art.</p>
<p><img alt="Waking Life" src="files/2010/07/wakinglife1.jpg"></p>
<p>As an amateur graphics programmer, I don't have large resources nor much
experience to throw at the problem, so my options and my abilities are
limited. But, like a good artist, I believe it should still be possible
to create things that are both strikingly beautiful and highly
functional, either by working with the restrictions of the medium, or by
finding creative ways to exploit or extend them.</p>
<p><img alt="Love" src="files/2010/07/love.jpg"></p>
<p>In particular, the kind of minimal, clean-lined aesthetic that amateur
OpenGL programs take on by default are useful for their crisp precision,
as charting and visualisation tools. But above that, I love them for
their stark minimalism, their clean lines and homogeneous fields of
colour.</p>
<p><img alt="Tron Legacy" src="files/2010/07/tron.jpg"></p>
<p>I wish more professional game developers had an incentive to aim for
less conventional aesthetics - whether they be deliberately retro, or
else striking out in some new direction of their own. It's that brave
minority of projects which do this which form my inspiration.</p>
<h3><strong>Starting Point</strong></h3>
<p>I'm assuming we already have a minimal OpenGL application, that:</p>
<ul>
<li>Opens a window</li>
<li>Provides an OpenGL context for us to render to</li>
<li>Sets appropriate 3D projection matrix</li>
<li>Sets the initial modelview matrix state based on the position and
  orientation of a 'camera' object</li>
<li>Calls our empty 'draw' function once per monitor refresh.</li>
</ul>
<p>This results in a blank screen, at 60fps. Here's a screenshot, so you
can see exactly what it's doing:</p>
<p><img alt="A blank screen" src="files/2010/07/blank1.png"></p>
<p>I'm using pyglet &amp; PyOpenGL for this, but this isn't important. Any
framework that provides the above abilities, such as PyGame, along with
bindings to OpenGL, will be just fine. Whichever framework you use, this
minimal application might take on the order of about 150 lines of code,
and is covered in countless tutorials all over the web.</p>
<p>From here on in I plan to show (or at least describe) pretty much all of
the code that I add on top of this minimal OpenGL loop.</p>
<h3><strong>Goal</strong></h3>
<p>To begin with, I'm going to lead you as quickly as I can through a Shape
class, that model 3D shapes, in a way useful for the creation of
geometry, and then a Glyph class that converts these geometries into
arrays for OpenGL. Finally these arrays get passed into a Render class,
which simply calls glDrawElements to render them.</p>
<p><img alt="Our Goal" src="files/2010/07/fun-stuff.png"></p>
<p>Once the above infrastructure is in place, we can have some fun
generating interesting shapes to make pretty pictures with. The
conventional way to provide geometry to your OpenGL code is by loading
your data from files. Today though, I want to stick with generating
geometry from code, to see where that leads.</p>
<h3><strong>Modelling Polyhedra</strong></h3>
<p>A polyhedron is a 3D shape with flat faces and straight edges. We can
model coloured polyhedra using a simple Shape class:</p>
<pre class="code literal-block"><span class="n">Vec3</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'Vec3'</span><span class="p">,</span> <span class="s1">'x y z'</span><span class="p">)</span>
<span class="n">Color</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'Color'</span><span class="p">,</span> <span class="s1">'r g b a'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Shape</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">face_colors</span><span class="p">):</span>
        <span class="c1"># list of Vec3s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span>

        <span class="c1"># list of faces, each face is a list of indices into 'vertices'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">faces</span>

        <span class="c1"># List of colors, one per face</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_colors</span> <span class="o">=</span> <span class="n">face_colors</span>
</pre>
<p>An instance of this class, for example, might represent a yellow cube,
or a tetrahedron with green and black faces, or any other coloured
polyhedron we can imagine.</p>
<p>To demonstrate how classes Shape, Glyph and Render hang together, let's
examine an even simpler example, a yellow triangle joined to a red
square:</p>
<p><img alt="Red Triangle &amp; Yellow Square" src="files/2010/07/triangle-square.png"></p>
<p>You can see this geometry features five vertices (v0 to v4), which are
used by the two faces. This might be represented by an instance of
Shape:</p>
<pre class="code literal-block"><span class="n">v0</span> <span class="o">=</span> <span class="n">Vec3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">Vec3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">Vec3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">v3</span> <span class="o">=</span> <span class="n">Vec3</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">v4</span> <span class="o">=</span> <span class="n">Vec3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">red</span> <span class="o">=</span> <span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">yellow</span> <span class="o">=</span> <span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

<span class="n">shape</span> <span class="o">=</span> <span class="n">Shape</span><span class="p">(</span>
    <span class="n">vertices</span><span class="o">=</span><span class="p">[</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v4</span><span class="p">],</span>
    <span class="n">faces</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>    <span class="c1"># f0, triangle</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="c1"># f1, square</span>
    <span class="p">],</span>
    <span class="n">face_colors</span><span class="o">=</span><span class="p">[</span><span class="n">red</span><span class="p">,</span> <span class="n">yellow</span><span class="p">],</span>
<span class="p">)</span>
</pre>
<p>The integers in the 'faces' member are indices into the vertices list.
So the triangular face, for example, is formed by linking vertices 2, 3
and 4.</p>
<h3><strong>Step 1. Creating a Ctypes Vertex array</strong></h3>
<p>In order to render our Shape, we need to convert it to some ctypes
arrays that OpenGL will eat:</p>
<ul>
<li>glvertices - an array of GLfloats (three for each vertex)</li>
<li>glindices - an array of GLubytes (one for each index of each face)</li>
<li>glcolors - an array of GLubytes (four for each vertex)</li>
</ul>
<p>To generate glvertices, we need to dereference the indices in
Shape.faces, to produce a new list of vertices, rearranged into the
order they are going to be drawn:</p>
<p><img alt="Step 1. Dereference indices" src="files/2010/07/dereference-indices.png"></p>
<p>The most visible aspect of this change is that the vertices are
re-ordered, such that the indices now simply read '0, 1, 2, 3, 4, 5...'.
However that isn't actually necessary. The important part of this
transformation is that vertices which are re-used are now duplicated in
the vertex list. For example v0 now occurs twice. As a result of this
vertex duplication, one the two instances of '0' in the faces lists now
instead reads '3' (referencing the new second copy of v0).</p>
<p>This duplication of vertices is required, because when v0 is used for
the first time, it is as part of the red triangle, and when it is used
the second time it is as part of the yellow square. The color of the
vertex changes from one occurrence to the next. All the attributes of a
vertex (position, color, texture co-ords, normals, etc) are treated as
an atomic unit, so whenever any attribute changes, as the color is
changing here, the vertex position needs to be redundantly specified
again, so as to create a new unique vertex with its own unique attribute
values. Even if the color of v0 in our example was identical for each
use, we will see later that other vertex attributes such as surface
normals will still differ. Don't sweat trying to eliminate these
redundancies, they are necessary, unless every single attribute of the
re-used vertex (including surface normals) are identical.</p>
<p>The code in Glyph.get_glverts() performs this dereferencing step:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Glyph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_glverts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">num_glverts</span><span class="p">):</span>
        <span class="n">glverts</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">faces</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">face</span>
        <span class="p">)</span>
        <span class="n">ArrayType</span> <span class="o">=</span> <span class="n">GLfloat</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_glverts</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="o">*</span><span class="n">glverts</span><span class="p">)</span>
</pre>
<p>This uses a generator to produce the vertices in the order that we need
them. 'ArrayType' shows the standard idiom to create a ctypes array - we
take the datatype of the array elements, in this case GLfloat since our
vertex positions consist of three floats, and multiply it by the
required length of the array. This yields a new array type. The final
return statement instantiates this array type using the data supplied by
the glverts generator.</p>
<h3><strong>Step 2. Creating Ctypes Index Arrays</strong></h3>
<p>The second job Glyph has to do is create a ctypes indices array, which
is derived from the Shape's faces. In doing this, it has to break the
Shape's faces down into individual triangles.</p>
<p><img alt="Step 2. Tessellate indices" src="files/2010/07/tessellate-indices.png"></p>
<p>The vertex list is unchanged by this step, and the first face - the
triangle - is also unchanged. The second face, the square, has been
broken into two triangles.</p>
<p>There are well-known algorithms for breaking an arbitrary polygon down
into individual triangles. Using the utility functions found in the GLU
library, this can be done in about 150 lines of Python. But in the
interests of keeping it simple, I decided to restrict our code to just
handling convex faces. Tessellating these faces can be done using a
considerably simpler algorithm:</p>
<pre class="code literal-block"><span class="k">def</span> <span class="nf">tessellate</span><span class="p">(</span><span class="n">face</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Break the given face into triangles.</span>
<span class="sd">    e.g. [0, 1, 2, 3, 4] -&gt;</span>
<span class="sd">    [[0, 1, 2], [0, 2, 3], [0, 3, 4]]</span>
<span class="sd">    Does not work on concave faces.</span>
<span class="sd">    '''</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">face</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">face</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
</pre>
<p>We again use a generator, to simply join up the face's first vertex with
all the other vertices, like this:</p>
<p><img alt="Tessellation of convex faces" src="files/2010/07/tessellation.png"></p>
<p>Now we have our tessellate function, Glyph can now create the glindices
array in much the same way as it generated the glvertices. I wasn't
smart enough to write this as a generator first time around, I presume
it would require more than one generator to do it (anyone?), so I'm
needlessly creating an in-memory copy of the sequence, but it turns out
I need to take its length right afterwards anyway, so what the heck:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Glyph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_glindices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">faces</span><span class="p">):</span>
        <span class="n">glindices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">face_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">(</span><span class="n">face_offset</span><span class="p">,</span> <span class="n">face_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">))</span>
            <span class="n">glindices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">tessellate</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>
            <span class="n">face_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
        <span class="n">ArrayType</span> <span class="o">=</span> <span class="n">GLubyte</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">glindices</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">glindices</span><span class="p">)</span>
</pre>
<p>This is more complex than get_glvertices because it is performing both
of the transformations described in steps 1 and 2. But it's still pretty
straightforward. Note that the type of the index array will have change
from GLubytes to GLushorts (or GLuints) if the number of vertices rises
above 256 (or 65,536.)</p>
<h3><strong>Step 3. Creating Ctypes Color Arrays</strong></h3>
<p>Finally, we need an array of vertex colors. This is the simplest of the
lot, generated by repeating the face_color for each face, once per
vertex:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Glyph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_glcolors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">face_colors</span><span class="p">,</span> <span class="n">num_glvertices</span><span class="p">):</span>
        <span class="n">glcolors</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
            <span class="n">repeat</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">face</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">faces</span><span class="p">,</span> <span class="n">face_colors</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ArrayType</span> <span class="o">=</span> <span class="n">GLubyte</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_glvertices</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">glcolors</span><span class="p">))</span>
</pre>
<h3><strong>First Light</strong></h3>
<p>It's might seem like a teensy bit of a slog to get here, but it hasn't
been more than sixty lines of code, and now we're in a position to pass
our ctypes arrays into OpenGL's drawElements. This happens in our
Render.draw() method:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Render</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
            <span class="n">glVertexPointer</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">GL_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glvertices</span><span class="p">)</span>
            <span class="n">glColorPointer</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glcolors</span><span class="p">)</span>

            <span class="c1"># TODO: handle the item's position and orientation</span>

            <span class="n">glDrawElements</span><span class="p">(</span>
                <span class="n">GL_TRIANGLES</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glindices</span><span class="p">),</span>
                <span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
                <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glindices</span>
            <span class="p">)</span>
</pre>
<p>This is canonical OpenGL render code, so I'm not going to dissect it,
but now we get some actual visible output:</p>
<p><img alt="Red triangle, yellow square" src="files/2010/07/screen-triangle-square.png"></p>
<p>Hooray! \o/ We can move our camera position around, and view this 3D
object from different angles.</p>
<p>There's a minor wrinkle here that I'm glossing over. I've turned on
backface culling, so the triangle and square aren't visible if we view
them from the back. For all our future examples I plan on using closed
polyhedra, so we won't be able to see the 'backs' of the faces - those
will be on the inside of the polyhedron.</p>
<h3><strong>The Fun Stuff</strong></h3>
<p>So now we've got all our infrastructure in place, we can start creating
factory functions to churn out some Shapes. Let's start with something
straightforward, a tetrahedron (triangle-based pyramid):</p>
<pre class="code literal-block"><span class="k">def</span> <span class="nf">Tetrahedron</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">face_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">edge</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="o">+</span><span class="n">size</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="o">+</span><span class="n">size</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">),</span>
        <span class="p">(</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">Shape</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">face_colors</span><span class="p">)</span>
</pre>
<p>Which produces a tetrahedron:</p>
<p><img alt="A tetrahedron" src="files/2010/07/screen-tetrahedron.png"></p>
<p>Then a cube factory:</p>
<pre class="code literal-block"><span class="k">def</span> <span class="nf">Cube</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">face_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">edge</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">repeat</span><span class="p">([</span><span class="o">-</span><span class="n">e2</span><span class="p">,</span> <span class="o">+</span><span class="n">e2</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="c1"># left</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># right</span>
        <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># front</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="c1"># back</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="c1"># top</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># bottom</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">Shape</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">face_colors</span><span class="p">)</span>
</pre>
<p>The six faces are quite evident, but the use of <em>itertools.product</em> to
produce the list of vertices perhaps deserves a bit of exposition. It's
an inspired tip from <a href="http://tzotzioy.blogspot.com/">Î¤Î–Î©Î¤Î–Î™ÎŸÎ¥</a>.
Just to spell it out in longhand:</p>
<pre class="code literal-block"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">product</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">repeat</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
<span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
</pre>
<p>So there are the eight vertices of the cube, and that gets us the
following:</p>
<p><img alt="A cube" src="files/2010/07/screen-cube.png"></p>
<p>We can add a few more vertices and faces, to make ourselves a truncated
cube:</p>
<p><img alt="A truncated cube" src="files/2010/07/screen-truncated-cube.png"></p>
<p>Once we've got truncated cubes, we might as well add one last face to
form the entrance:</p>
<p><img alt="A truncated cube with entrance" src="files/2010/07/screen-space-station.png"></p>
<p>There's nothing to stop us adding several of these shapes into the world
at once, but since we haven't yet moved any of them away from the
origin, they just sit there, embedded within one another:</p>
<p><img alt="A cube and tetrahedron interpenetrate" src="files/2010/07/screen-cube-tetra.png"></p>
<p><img alt="A truncated cube with two tetrahedrons" src="files/2010/07/screen-trunccube-two-tetras.png"></p>
<h3><strong>Moving objects around</strong></h3>
<p>In our earlier Render.draw() method, we left a 'TODO' comment in place,
to note that we weren't yet handling item positions and orientations.
Here's what Render.draw looks like when we fill that code in:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Render</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">world</span><span class="p">:</span>
            <span class="n">glVertexPointer</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">GL_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glvertices</span><span class="p">)</span>
            <span class="n">glColorPointer</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glcolors</span><span class="p">)</span>

            <span class="n">glPushMatrix</span><span class="p">()</span>
            <span class="n">glTranslatef</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

            <span class="n">glDrawElements</span><span class="p">(</span>
                <span class="n">GL_TRIANGLES</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glindices</span><span class="p">),</span>
                <span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
                <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glindices</span>
            <span class="p">)</span>
            <span class="n">glPopMatrix</span><span class="p">()</span>
</pre>
<p>Again, this is very standard OpenGL usage. To set an item's <em>position</em>
attribute, I'm going to use a bit of code that I already snuck into the
demo without telling you about. It's the code that moves the camera
around in space. A simplified version is here, class Orbit, which will
return a new position each time it gets called. The locus of this
position is an orbit around the origin:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">Orbit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">bearing</span> <span class="o">=</span> <span class="n">time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bearing</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bearing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Vec3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre>
<p>The actual camera uses a slightly longer version I call WobblyOrbit (not
shown), which operates in exactly the same way. Any 'mover' class, i.e.
one that returns a Vec3 position when called, can be used to move the
camera, or any other item, around in space:</p>
<pre class="code literal-block"><span class="k">class</span> <span class="nc">GameItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span> <span class="n">kwargs</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="n">world</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">GameItem</span><span class="p">(</span>
    <span class="n">shape</span><span class="o">=</span><span class="n">Cube</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">red</span><span class="p">)),</span>
    <span class="n">mover</span><span class="o">=</span><span class="n">Orbit</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
<span class="p">)</span> <span class="p">)</span>

<span class="c1"># then, in world.update():</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">mover</span><span class="p">:</span>
        <span class="n">item</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">mover</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</pre>
<p>Similarly, we can spin items using 'spinner' classes, that tweak an
item's orientation as time goes by.</p>
<p>With these all in place, we can now add many Shapes to the world, each
moving and rotating independently:</p>
<p><img alt="Several independantly positioned and oriented shapes" src="files/2010/07/screen-several-shapes.png"></p>
<h3><strong>Next week: Composite Shapes...</strong></h3>
<p>This is all great as far as it goes, but it turns out we have a
performance problem. Adding more than about 450 shapes at once starts to
slow down below 60fps (This is all on my trusty 2005-era Thinkpad T60
laptop.) The bottleneck turns out to be in our Render.draw() loop. Each
of those OpenGL functions are from (wrappers around) the OpenGL C
library, and calling across the Python / C boundary like this incurs a
per-function call overhead. Also, a second looming problem is that
creating more interesting shapes is going to become more onerous and
error-prone, as we create longer and more complex lists of vertices and
faces in our code.</p>
<p>One partial solution to both these problems is to use composite shapes,
in which we can compose many copies of our basic shapes into one single,
more complex shape. This will allow us to use algorithmic means to
produce more fun geometry, and will also help us draw more complex
shapes, composed of many simpler shapes, without requiring several
separate OpenGL function calls for each of the simple shapes.</p>
<p><a href="posts/flying-high-opengl-from-python-part-2">On to Part 2 &gt;&gt;</a></p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/loving-europython-tutorials/" class="u-url">Loving EuroPython Tutorials</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/loving-europython-tutorials/" rel="bookmark">
            <time class="published dt-published" datetime="2010-07-19T00:08:53-05:00" itemprop="datePublished" title="2010-07-19 00:08">2010-07-19 00:08</time></a>
            </p>
                <p class="commentline">            <a href="posts/loving-europython-tutorials/#disqus_thread" data-disqus-identifier="cache/posts/loving-europython-tutorials.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I've been loving the two days of tutorials preceding the EuroPython
conference. This morning I attended <a href="http://www.mechanicalcat.net/richard/log">Richard
Jones</a>' splendid <em>Introduction
to Game Programming</em>. It was an absolute pleasure to be walked through
the creation of an example game like this, using Python game libraries
like <a href="http://pyglet.org/">pyglet</a> and <a href="http://cocos2d.org/">Cocos</a>, by
someone who really knows what he's doing. Also, it's nice to have
something visible to show after a morning's work:</p>
<p><img alt="My asteroids." src="files/2010/07/intro-to-game-programming.jpg"></p>
<p>(Michael your idea of making engine thrust always visible was exactly what I
needed to help me capture the screenshot.)</p>
<p>The code is based very heavily on samples that Richard provided and
talked us through in great detail, so although I now understand it
pretty thoroughly, I can't take much credit. Excepting, that is, for a
handful of minor tweaks I couldn't resist making along the way, like the
flickery animated engine thrust, that made me gurgle with delight.</p>
<p>For the artwork, I stole the shuttle icon (sssshhhhhh!), added the
engine thrust, and created the asteroids themselves entirely from
scratch in Gimp. They are just rotatable bitmaps, albeit designed in
homage of vector graphics of yore, complete with simulated CRT glow.
Brilliant!</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/undocumented-feature-of-the-week-pip_download_cache/" class="u-url">Undocumented feature of the week: $PIP_DOWNLOAD_CACHE</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/undocumented-feature-of-the-week-pip_download_cache/" rel="bookmark">
            <time class="published dt-published" datetime="2010-07-13T12:46:15-05:00" itemprop="datePublished" title="2010-07-13 12:46">2010-07-13 12:46</time></a>
            </p>
                <p class="commentline">            <a href="posts/undocumented-feature-of-the-week-pip_download_cache/#disqus_thread" data-disqus-identifier="cache/posts/undocumented-feature-of-the-week-pip_download_cache.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Use Python? You should be using
<a href="http://pypi.python.org/pypi/pip"><em>Pip</em></a>. A replacement for
<em>easy_install</em>, that supports uninstalling and plays nice with
<a href="http://pypi.python.org/pypi/virtualenv"><em>virtualenv</em></a>. An <em>apt-get</em> for
Python packages, if you will.</p>
<p>It has a marvellous undocumented feature. Set the environment variable
PIP_DOWNLOAD_CACHE to prevent re-downloading the same packages
repeatedly when setting up environments on the same machine:</p>
<pre class="code literal-block"><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">PIP</span><span class="w"></span>
<span class="n">PIP_DOWNLOAD_CACHE</span><span class="o">=</span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Documents</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Settings</span><span class="err">\</span><span class="n">jhartley</span><span class="err">\</span><span class="p">.</span><span class="n">pip_download_cache</span><span class="w"></span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>
<span class="n">Downloading</span><span class="o">/</span><span class="n">unpacking</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>
<span class="n">Creating</span><span class="w"> </span><span class="n">supposed</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Documents</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Settings</span><span class="err">\</span><span class="n">jhartley</span><span class="err">\</span><span class="p">.</span><span class="n">pip_download_cache</span><span class="w"></span>
<span class="w"> </span><span class="n">Downloading</span><span class="w"> </span><span class="n">mock</span><span class="o">-</span><span class="mf">0.7.0</span><span class="n">b2</span><span class="p">.</span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="mi">242</span><span class="n">Kb</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="mi">242</span><span class="n">Kb</span><span class="w"> </span><span class="n">downloaded</span><span class="w"></span>
<span class="w"> </span><span class="n">Storing</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="nl">c</span><span class="p">:</span><span class="err">\</span><span class="n">documents</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">settings</span><span class="err">\</span><span class="n">jhartley</span><span class="err">\</span><span class="p">.</span><span class="n">pip_download_cache</span><span class="err">\</span><span class="n">http</span><span class="o">%</span><span class="mi">3</span><span class="n">a</span><span class="o">%</span><span class="mi">2</span><span class="n">f</span><span class="o">%</span><span class="mi">2</span><span class="n">fpypi</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">org</span><span class="o">%</span><span class="mi">2</span><span class="n">fpackages</span><span class="o">%</span><span class="mi">2</span><span class="n">fsource</span><span class="o">%</span><span class="mi">2</span><span class="n">fm</span><span class="o">%</span><span class="mi">2</span><span class="n">fmock</span><span class="o">%</span><span class="mi">2</span><span class="n">fmock</span><span class="o">-</span><span class="mf">0.7.0</span><span class="n">b2</span><span class="p">.</span><span class="n">zip</span><span class="w"></span>
<span class="o">[</span><span class="n">snip</span><span class="o">]</span><span class="w"></span>
<span class="n">Successfully</span><span class="w"> </span><span class="n">installed</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">uninstall</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>
<span class="o">[</span><span class="n">snip</span><span class="o">]</span><span class="w"></span>
<span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">uninstalled</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>
<span class="n">Downloading</span><span class="o">/</span><span class="n">unpacking</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>
<span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Documents</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Settings</span><span class="err">\</span><span class="n">jhartley</span><span class="err">\</span><span class="p">.</span><span class="n">pip_download_cache</span><span class="err">\</span><span class="n">http</span><span class="o">%</span><span class="mi">3</span><span class="n">A</span><span class="o">%</span><span class="mi">2</span><span class="n">F</span><span class="o">%</span><span class="mi">2</span><span class="n">Fpypi</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">org</span><span class="o">%</span><span class="mi">2</span><span class="n">Fpackages</span><span class="o">%</span><span class="mi">2</span><span class="n">Fsource</span><span class="o">%</span><span class="mi">2</span><span class="n">Fm</span><span class="o">%</span><span class="mi">2</span><span class="n">Fmock</span><span class="o">%</span><span class="mi">2</span><span class="n">Fmock</span><span class="o">-</span><span class="mf">0.7.0</span><span class="n">b2</span><span class="p">.</span><span class="n">zip</span><span class="w"></span>
<span class="o">[</span><span class="n">snip</span><span class="o">]</span><span class="w"></span>
<span class="n">Successfully</span><span class="w"> </span><span class="n">installed</span><span class="w"> </span><span class="n">mock</span><span class="w"></span>
</code></pre>

<p>(This text is copied from my unholy bastardised shell of choice at work,
Windows CMD shell with Cygwin binaries foremost on the PATH.)</p>
<p>Using the download cache like this is substantially faster. Exactly what
you need if you're continually setting up environments under various
version of Python for testing or what-have-you.</p>
<p>The directory is created if it doesn't exist. Network access is still
required when installing like this, presumably for the version checks.</p>
<p>Thanks to the irrepressible
<a href="http://www.voidspace.org.uk/python/weblog/arch_d7_2010_07_10.shtml#e1185">fuzzyman</a>
for bringing this to my attention.</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/i-am-such-a-child/" class="u-url">I am such a child</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/i-am-such-a-child/" rel="bookmark">
            <time class="published dt-published" datetime="2010-07-10T13:36:20-05:00" itemprop="datePublished" title="2010-07-10 13:36">2010-07-10 13:36</time></a>
            </p>
                <p class="commentline">            <a href="posts/i-am-such-a-child/#disqus_thread" data-disqus-identifier="cache/posts/i-am-such-a-child.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Dear Julio,</p>
<p>Many thanks for considering me for this opportunity. I feel as though my
skills are a good match for the position, and would like you to consider
my application.</p>
<p>I feel as though this is the start of a new phase in life for me, as
though I have really rounded a corner. I have not used a computer, but
my nephew says he will meet me tomorrow afternoon to teach me how to do
it. Also, my therapist says that my bouts of incoherent rage will
continue to diminish, so that will be good in my new job. My probation
for stealing from my previous employer is almost up.</p>
<p>I am high, but I can absolutely have this under control and be
completely sober by Monday, when I trust you will call me at your
earliest convenience.</p>
<p>Best regards,</p>
<p>Jonathan Hartley</p>
<p>-------- Original Message --------</p>
<hr>
<p>Subject:   offer number 078
  Date:      Fri, 9 Jul 2010 17:28:46 -0500
  From:      <a href="mailto:tartley@tartley.com"></a>
  To:        </p>
<hr>
<p>My name is Julio YEPES, I am a hiring manager with ...</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/more-colored-terminal-text-on-windows-ansicon/" class="u-url">More Colored Terminal text on Windows: AnsiCon</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/more-colored-terminal-text-on-windows-ansicon/" rel="bookmark">
            <time class="published dt-published" datetime="2010-07-08T14:07:09-05:00" itemprop="datePublished" title="2010-07-08 14:07">2010-07-08 14:07</time></a>
            </p>
                <p class="commentline">            <a href="posts/more-colored-terminal-text-on-windows-ansicon/#disqus_thread" data-disqus-identifier="cache/posts/more-colored-terminal-text-on-windows-ansicon.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>A reminder for myself:</p>
<p>ANSI escape characters don't work properly in Windows terminals:</p>
<p><img alt="Before: Raw ANSI codes. Not nice." src="files/2010/07/ansicon00-before.png"></p>
<p>To make them work properly, use
<a href="http://adoxa.110mb.com/ansicon/index.html">AnsiCon</a>. Unzip it somewhere
permanent (eg. <code>%ProgramFiles%\ansicon</code>) and install it with:</p>
<pre class="code literal-block"><span></span><code><span class="err">ansicon.exe -i</span>
</code></pre>

<p>start a new terminal, and lo:</p>
<p><img alt="After: Pretty." src="files/2010/07/ansicon01-working.png"></p>
<p>Fine tune the appearance of the programs generating the color, for
example customise 'hg diff' by editing \~/.hgrc:</p>
<pre class="code literal-block"><span></span><code><span class="p p-Indicator">[</span><span class="nv">extensions</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">color =</span>

<span class="l l-Scalar l-Scalar-Plain">[color]</span>
<span class="l l-Scalar l-Scalar-Plain">status.modified = yellow bold</span>
<span class="l l-Scalar l-Scalar-Plain">status.unknown = white</span>
<span class="l l-Scalar l-Scalar-Plain">status.deleted = red_background white bold</span>

<span class="l l-Scalar l-Scalar-Plain">diff.deleted = red bold</span>
<span class="l l-Scalar l-Scalar-Plain">diff.inserted = green bold</span>
<span class="l l-Scalar l-Scalar-Plain">diff.file_a = white</span>
<span class="l l-Scalar l-Scalar-Plain">diff.file_b = white</span>
<span class="l l-Scalar l-Scalar-Plain">diff.diffline = white_background black</span>
<span class="l l-Scalar l-Scalar-Plain">diff.extended = yellow bold</span>
<span class="l l-Scalar l-Scalar-Plain">diff.hunk = underline black</span>
<span class="l l-Scalar l-Scalar-Plain">diff.changed = yellow bold</span>
</code></pre>

<p><img alt="Fine-tuned" src="files/2010/07/ansicon02-tuned.png"></p>
<p>ANSI is correctly stripped out if the output of a program is not a
terminal, so the colored output won't interfere with saving to files nor
machine-parsing of the text:</p>
<p><img alt="Filtered" src="files/2010/07/ansicon03-filtered.png"></p>
<p>Finally, insert some <a href="http://pueblo.sourceforge.net/doc/manual/ansi_color_codes.html">ANSI
codes</a>
into your <a href="http://ss64.com/nt/prompt.html">prompt</a>, by setting
environment variable PROMPT:</p>
<pre class="code literal-block"><span></span><code><span class="err">set PROMPT=$E[0;36m$P$_$E[36;1m$G$E[0m$S</span>
</code></pre>

<p><img alt="Colored Prompt" src="files/2010/07/ansicon04-prompt.png"></p>
<p><a href="http://tartley.com/?p=1062">Multiple</a>
<a href="http://tartley.com/?p=863">posts</a> on colors and terminal text is
perhaps a bit obsessive of me. I think I'm all done now.</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/more-opengl-from-python/" class="u-url">More OpenGL from Python</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/more-opengl-from-python/" rel="bookmark">
            <time class="published dt-published" datetime="2010-06-02T02:04:37-05:00" itemprop="datePublished" title="2010-06-02 02:04">2010-06-02 02:04</time></a>
            </p>
                <p class="commentline">            <a href="posts/more-opengl-from-python/#disqus_thread" data-disqus-identifier="cache/posts/more-opengl-from-python.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>My talk, <em>Flying High : Hobbyist OpenGL from Python</em>, was accepted for
EuroPython 2010, \o/. I don't want to reveal the best bits of my talks,
but to whet people's appetite, this is some of what my initial
preparation involved.</p>
<p>One thing I'm keen on talking about is algorithmic generation of
interesting geometry. This is an area in which the flexibility and
expressiveness of Python can really shine.</p>
<p>I started with a quick Shape class, to model the vertices and faces of
an arbitrary polyhedra (3D shapes with flat faces and straight edges):</p>
<pre class="code literal-block"><span></span><code><span class="n">Position</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'Position'</span><span class="p">,</span> <span class="s1">'x y z'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Shape</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="n">Position</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">faces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
</code></pre>

<p>Each face of the shape is represented as a list of integer indices into
the vertex list. The 'faces' attribute is a list of all faces. The color
attributes is just a 4 element tuple: (r, g, b, alpha). This class can
now be instantiated by factory functions to form particular 3D shapes,
such as red cubes or blue tetrahedrons:</p>
<pre class="code literal-block"><span></span><code><span class="k">def</span> <span class="nf">Cube</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">+</span><span class="n">edge</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="c1"># left</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># right</span>
        <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># front</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="c1"># back</span>
        <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="c1"># top</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># bottom</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">Shape</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
</code></pre>

<p>A class called 'Glyph' will convert a Shape instance into the set of
ctypes arrays that need to be passed to OpenGL:</p>
<p>The real Glyph class also creates arrays for color, and array indexes as
well as vertices.</p>
<p>Finally, we have a renderer, whose 'draw' method is invoked by our
window draw event. This iterates through all items in our world that
have a Glyph attribute, drawing each of them:</p>
<pre class="code literal-block"><span></span><code><span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">glPushMatrix</span><span class="p">()</span>

        <span class="n">gl</span><span class="o">.</span><span class="n">glTranslatef</span><span class="p">(</span><span class="o">*</span><span class="n">position</span><span class="p">)</span>

        <span class="c1"># TODO: orientation</span>

        <span class="n">gl</span><span class="o">.</span><span class="n">glVertexPointer</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">gl</span><span class="o">.</span><span class="n">GL_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glVerts</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">glColorPointer</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">gl</span><span class="o">.</span><span class="n">GL_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glColors</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">glDrawElements</span><span class="p">(</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">GL_TRIANGLES</span><span class="p">,</span>      <span class="c1"># draw disjoint triangles</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">glIndices</span><span class="p">),</span> <span class="c1"># number of vertices to draw</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">GL_UNSIGNED_SHORT</span><span class="p">,</span> <span class="c1"># type of indices</span>
            <span class="n">glyph</span><span class="o">.</span><span class="n">glIndices</span><span class="p">)</span>      <span class="c1"># index array</span>

        <span class="n">gl</span><span class="o">.</span><span class="n">glPopMatrix</span><span class="p">()</span>
</code></pre>

<p>So we add a couple of interpenetrated Cube() shaped items into our
world:</p>
<pre class="code literal-block"><span></span><code><span class="n">white</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">world</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">GameItem</span><span class="p">(</span>
    <span class="n">position</span><span class="o">=</span><span class="n">Position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">shape</span><span class="o">=</span><span class="n">Cube</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">white</span><span class="p">),</span>
    <span class="n">glyph</span><span class="o">=</span><span class="n">Glyph</span><span class="p">(),</span>
<span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">GameItem</span><span class="p">(</span>
    <span class="n">position</span><span class="o">=</span><span class="n">Position</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">shape</span><span class="o">=</span><span class="n">Cube</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">red</span><span class="p">),</span>
    <span class="n">glyph</span><span class="o">=</span><span class="n">Glyph</span><span class="p">(),</span>
<span class="p">))</span>
</code></pre>

<p>and running the program renders them:</p>
<p><img alt="" src="files/2010/06/two-cubes.png"></p>
<p>The flat shading is because we have no lighting yet. That gets fixed
soon.</p>
<p>Each cube is being drawn by a separate call to glDrawElements. This is
fine for small numbers of items, but for performance we'll want to
compose our geometry into single arrays that can be rendered by a single
call to glDrawElements. To do this, we create a CompositeShape object,
that contains several Shapes, and exposes 'vertices' and 'faces'
attributes just like a regular Shape, which aggregate the geometry of
all their subordinate Shapes.</p>
<pre class="code literal-block"><span></span><code><span class="k">class</span> <span class="nc">CompositeShape</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vertices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">vert</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
                <span class="k">for</span> <span class="n">vert</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
</code></pre>

<p>(The real CompositeShape class also defines 'faces', which is elided
here.) Instances of CompositeShape can be passed directly to our
unmodified Glyph class, allowing us to construct complex geometries out
of many individual parts, but now they are all rendered in a single
OpenGL API call.</p>
<p>A new factory function creates a fancy CompositeShape called a
CubeCluster, consisting of many randomly-positioned small cubes, each
one colored by its position in (r, g, b) space. These are surrounded by
a sprinkling of black cubes, a large translucent cube-shaped skin:</p>
<p><img alt="" src="files/2010/06/cube-cluster-01-overview.png"></p>
<p>and buried deep at the centre of the CubeCluster is some sort of
mysterious structure:</p>
<p><img alt="" src="files/2010/06/cube-cluster-01-center.png"></p>
<p>So using this code, I get 60fps on modest hardware (my 2005 end-of-line
Thinkpad T60, an ATI Radeon X1400) while rendering either:</p>
<ul>
<li>800 independently moving and rotating items, each a simple cube (8
    vertices, 8 colors, no normals, 36 indices = 12 triangles) for a
    total of 9600 triangles.</li>
</ul>
<p>or</p>
<ul>
<li>1 composite item comprising 9,000 cubes, (108,000 triangles)</li>
</ul>
<p>or any linear interpolation between these two extremes. (<strong>Update:</strong> see
improvement on this noted in the final paragraph.)</p>
<p>I've done nothing to try and tune the performance, in particular I'm
updating and rendering every single item every frame, and I'm not using
vertex buffers, so I suspect my geometry is being sent over the bus to
the GPU every frame. So presumably this can be still be much improved.</p>
<p>Next I add some basic lighting, so that our cubes don't look so flat
shaded. Lighting needs to know normals, the vector at right angles to a
face, so that it can figure out how how strongly each face is
illuminated. So our Glyph needs to start generating an array of normals
for each vertex.</p>
<pre class="code literal-block"><span></span><code><span class="k">def</span> <span class="nf">get_normal</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">vertices</span><span class="p">):</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">face</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">-</span> <span class="n">v1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Glyph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_glnormals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="n">face_normals</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_normal</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">shape</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>
        <span class="n">normals</span> <span class="o">=</span> <span class="p">(</span><span class="n">normal</span>
                   <span class="k">for</span> <span class="n">face</span><span class="p">,</span> <span class="n">normal</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">face_normals</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">face</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gl_array</span><span class="p">(</span><span class="n">gl</span><span class="o">.</span><span class="n">GLfloat</span><span class="p">,</span> <span class="n">normals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_glvertices</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
</code></pre>

<p>This generation of normals also affects the generation of vertex
positions, colors and indices, since vertices can no longer be shared
between different faces of a cube, because a single vertex position now
requires a different normal for each face.</p>
<p><img alt="" src="files/2010/06/basic-lighting.jpg"></p>
<p>Generating normals made me think more about when I should or should not
be using indexed vertex arrays, as opposed to simple contiguous arrays
of vertices. My current thoughts on the matter are summarised on <a href="http://stackoverflow.com/questions/2954349/when-should-i-use-indexed-arrays-of-opengl-vertices">this
stackoverflow
question</a>.
If you know a bunch about OpenGL, I'd appreciate you heading over there
and setting me straight.</p>
<p>Adding normals increased the vertex count required to draw the same
geometry quite considerably, from 8 vertices for a single cube, up to
24. The colors array increases in size correspondingly. Surprisingly,
this didn't decrease framerate too much (we went from drawing 9,000
cubes at 60fps down to 8,000.) However, then I converted colors from
being floats (eg. white=(1.0, 1.0, 1.0, 1.0), four components for rgb
and alpha)) to using unsigned bytes (e.g. white=(255, 255, 255, 255).)
This boosted performance noticeably, so now we're up to drawing 12,000
cubes at 60fps, with normals and lighting.</p>
<p>Next up is to start generating some more interesting geometry, other
than just a bunch of cubes...</p>
<p><strong>Update:</strong> The code that generated the above screenshots is in a
Mercurial repo at:\
<a href="http://code.google.com/p/flyinghigh-opengl-from-python/">http://code.google.com/p/flyinghigh-opengl-from-python/</a></p>
<p>Only the "code" directory is of any interest (the rest is just a dumping
ground for my thoughts related to the text of the talk.) There is a
hastily-created README in the code directory.</p>
<p>In particular, note that the code may spend a while generating geometry
on startup, before displaying anything. This startup time has been
fluctuating wildly, as I add new ideas, then refine them to be
reasonably performant. To improve performance or startup time, you might
want to take a look in the 'flyinghigh/populate_world.py' module and
comment out the creation of some of the GameItem instances that are
passed to world.add().</p>
<p>Feedback, ideas and questions all welcome.</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/the-great-resolver-ide-anecdote/" class="u-url">The Great Resolver IDE Anecdote</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/the-great-resolver-ide-anecdote/" rel="bookmark">
            <time class="published dt-published" datetime="2010-05-04T12:56:47-05:00" itemprop="datePublished" title="2010-05-04 12:56">2010-05-04 12:56</time></a>
            </p>
                <p class="commentline">            <a href="posts/the-great-resolver-ide-anecdote/#disqus_thread" data-disqus-identifier="cache/posts/the-great-resolver-ide-anecdote.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Found myself telling this story yet again, so I figured I should just
post it here and start linking to it, rather than remembering, retyping
and re-embellishing it every time.</p>
<p>Ever since we started at <a href="http://www.resolversystems.com/">Resolver</a>,
developers have been free to choose their own IDE (Integrated
Development Environment, although some of the ones I'm going to talk
about aren't so integrated, so I guess you should just read 'IDE' herein
to mean 'development environment').</p>
<p>Like herding cats, this of course resulted in everyone choosing a
different IDE. At one peak, we had fourteen people, and about ten
different IDEs. Sigh. To our incredulity though, this worked fine, and
everyone was happy. So far, so good.</p>
<p>We pair program, so we see a lot of each other's IDEs. In fact, we end
up learning them all pretty thoroughly. Spending eight hours a day,
every day, using someone else's IDE, with a bona-fide expert in that IDE
sitting in your lap, guiding you through it, will tend to do that. After
a few months, we all knew every IDE out there back-to-front. An example
of how pairing spreads knowledge.</p>
<p>Every so often, someone would change their mind about their chosen IDE.
Having been educated about the alternatives, they would decide to
switch. This was also fine, and everyone continued to be happy.</p>
<p>Then, after a few months of this, an interesting thing happened.
Gradually, one by one, twelve of our fourteen people each decided, of
their own accord, to switch to using either Vi or Emacs.</p>
<p>I regard this of an example of pairing not just spreading knowledge, but
spreading <em>enlightenment</em>.</p>
<p>They each had realised that although these hallowed text editors didn't
have some of the more advanced features they'd come to expect from an
IDE, such as auto-completion or 'go to definition', they were flexible
and powerful enough that one could add such features yourself. To do so
is a rite of passage for an experienced programmer, akin to Luke
building his own lightsaber - so that it's customized to his precise
needs, and he understands each nuance of its behaviour.</p>
<p>More than that, all the conveniences of a traditional IDE made it very
convenient to do only what the authors of the IDE had envisaged. To do
anything else was made very difficult. If you wished to use a different
compiler, or write in a different language than those prescribed by your
IDE vendor, you were out of luck, and would have to learn an entirely
different IDE to do that.</p>
<blockquote>
<p><em>"We shape our tools and afterwards our tools shape us."</em></p>
<ul>
<li>Marshall McLuhan ('The media is the message' guy)</li>
</ul>
</blockquote>
<p>On one project, or two, this might seem a trivial restriction. Extended
over the course of a lifetime, the conveniences shields a developer from
learning anything other than how to drive an IDE, and the restrictions
become blinkers, crippling their scope and abilities. The IDE is a
cage... for your <em>mind</em>.</p>
<p><img alt="" src="files/2010/05/matrix_morpheus_red_blue_pill.jpg"></p>
<p>The outliers are worth noting: We still use Visual Studio on rare
occasions, for the lovely built-in GUI designer. The irrepressible
Michael Foord loves Wing, and stuck with that. Will Reade, our tame
brainiac, stuck with transparent simplicity of the lightweight but
surprisingly useful TextPad. Go figure.</p>
<p><strong>Update</strong>: The coda to the outliers is also interesting. Nowadays we're
embedded in a huge mission to free our codebase from embedded win32
controls, so that we might have a chance of running under Mono, and
hence on other platforms. It would be nice if we could escape Windows
Forms altogether - I understand WPF would let us display our GUI on the
web. Writing this post makes me wonder - if we hadn't been using Visual
Studio's convenient GUI designer all along, is it remotely possible that
we might have considered our choice of GUI layer more thoroughly? If we
hadn't been entranced by the "obviously right" convenience of the Visual
Studio GUI designer, might our minds have been free enough to have made
this decision right the first time around?</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/colorama-simple-cross-platform-python-api-for-colored-terminal-text/" class="u-url">colorama: Simple cross-platform Python API for colored terminal text</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/colorama-simple-cross-platform-python-api-for-colored-terminal-text/" rel="bookmark">
            <time class="published dt-published" datetime="2010-04-21T10:18:30-05:00" itemprop="datePublished" title="2010-04-21 10:18">2010-04-21 10:18</time></a>
            </p>
                <p class="commentline">            <a href="posts/colorama-simple-cross-platform-python-api-for-colored-terminal-text/#disqus_thread" data-disqus-identifier="cache/posts/colorama-simple-cross-platform-python-api-for-colored-terminal-text.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Announcing new Python package,
<a href="http://pypi.python.org/pypi/colorama">Colorama</a>.</p>
<p>ANSI escape character sequences have long been used to produce colored
terminal text on Unix and Macs. Colorama makes this work on Windows,
too. It also provides some shortcuts to help generate these ANSI
sequences, and works fine in conjunction with any other ANSI sequence
generation library, such as Termcolor
(<a href="http://pypi.python.org/pypi/termcolor">http://pypi.python.org/pypi/termcolor</a>.)</p>
<p>This has the upshot of providing a simple cross-platform API for
printing colored terminal text from Python, and has the happy
side-effect that existing applications or libraries which use ANSI
sequences to produce colored output on Linux or Macs can now also work
on Windows, simply by calling <code>colorama.init()</code>.</p>
<p>I realise that printing colored terminal text is verging on
pathalogically superficial, but it has long irked me that this didn't
just work. Python should make this easy.</p>
<p>My mapping of ANSI conventions to the equivalent Win32 calls is far from
perfect. Currently it has the following results. ANSI codes under Ubuntu
on gnome-terminal:</p>
<p><img alt="" src="files/2010/04/screenshot-ubuntu-gnometerminal.png"></p>
<p>and the exact same ANSI codes printed on Windows under Colorama:</p>
<p><img alt="" src="files/2010/04/screenshot-winxp-console2.png"></p>
<p><strong>Update:</strong> I previously wrote here about discrepancies between the two,
which have since been fixed. The only outstanding issue is that colorama
does not support 'dim' text on Windows - it looks just the same as
'normal' text, and as far as I know, will never be able to.</p>
<p><a href="http://pypi.python.org/pypi/colorama">http://pypi.python.org/pypi/colorama</a></p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/my-own-competancy/" class="u-url">My own competency</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/my-own-competancy/" rel="bookmark">
            <time class="published dt-published" datetime="2010-04-07T11:41:50-05:00" itemprop="datePublished" title="2010-04-07 11:41">2010-04-07 11:41</time></a>
            </p>
                <p class="commentline">            <a href="posts/my-own-competancy/#disqus_thread" data-disqus-identifier="cache/posts/my-own-competancy.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>My single degree was in Electronics and Physics, so although that
covered a considerable amount of digital electronics and CPU design,
I've pretty much picked up everything I know about software in my own
time or on the job. Consequentially, there are aspects of computer
science I feel I don't know as well as I could. I'm thinking especially
of areas which are less frequently used in practice, but often cited as
fundamental and important, such as compiler design.</p>
<p>I stumbled on this '<a href="http://www.indiangeek.net/wp-content/uploads/Programmer%20competency%20matrix.htm">programmer competancy
matrix</a>'
the other week, and thought it would be a good first iteration of my own
syllabus of areas I'd like learn more about. So I cut'n'paste it into <a href="http://spreadsheets.google.com/ccc?key=0AmOF8t-e3EyzdE1FdW5BcDFuVURKOEZSY1NfQW5NS1E&amp;hl=en">a
spreadsheet</a>,
and starting annotating it with how confident I feel in each different
area, along with the next steps I'll need to strengthen my knowledge in
each area.</p>
<p>Startlingly but perhaps unsurprisingly, the tentative next step I
arrived at in almost all areas I feel deficient was to <em>finish working
through
<a href="http://www.amazon.co.uk/Structure-Interpretation-Computer-Electrical-Engineering/dp/0262510871">SICP</a></em>.
Alright, alright, my path is clear.</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/opengl-draw-api-visualised/" class="u-url">OpenGL Draw API Visualised</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Jonathan Hartley
            </span></p>
            <p class="dateline">
            <a href="posts/opengl-draw-api-visualised/" rel="bookmark">
            <time class="published dt-published" datetime="2010-03-20T13:15:54-05:00" itemprop="datePublished" title="2010-03-20 13:15">2010-03-20 13:15</time></a>
            </p>
                <p class="commentline">            <a href="posts/opengl-draw-api-visualised/#disqus_thread" data-disqus-identifier="cache/posts/opengl-draw-api-visualised.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>To help me grok and remember the OpenGL 3.3 draw API, I drew them in a
diagram. I hope this will help me see at a glance what I can and can't
achieve with each function call.</p>
<p><img alt="OpenGL array draw calls" src="files/2010/03/opengl-draw-calls.png"></p>
<p>I haven't annotated any of the parameter types. These days I tend to be
calling these functions from Python, so generally only care about the
values. Interestingly, the most recent additions to the API, such as
<code>glMultiDrawElements</code>, feature parameters such as
'<code>const void ** indices</code>'. Apparently the OpenGL Architecture Review
Board has also decided that they also no longer care about the types
either. Wise choice. :-)</p>
<p><strong>Updatate:</strong> I wanted to publish this diagram as SVG, but apparently
these days that works in every browser except IE, surprise surprise.</p>
</div>
    </div>
    </article>
</div>
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-20.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-18.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="tartley";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer"></footer>
</div>
</div>

            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
